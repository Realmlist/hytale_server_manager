name: Build and Release

on:
  push:
    tags:
      - 'v*'
  workflow_dispatch:
    inputs:
      version:
        description: 'Version to release (e.g., 1.0.0)'
        required: true

permissions:
  contents: write

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Get version
        id: version
        run: |
          if [ "${{ github.event_name }}" = "workflow_dispatch" ]; then
            echo "VERSION=${{ github.event.inputs.version }}" >> $GITHUB_OUTPUT
          else
            echo "VERSION=${GITHUB_REF#refs/tags/v}" >> $GITHUB_OUTPUT
          fi

      - name: Install frontend dependencies
        run: npm ci
        working-directory: frontend

      - name: Build frontend
        run: npm run build
        working-directory: frontend

      - name: Install server dependencies
        run: npm ci
        working-directory: server

      - name: Build server
        run: npm run build
        working-directory: server

      - name: Create release packages
        run: |
          VERSION=${{ steps.version.outputs.VERSION }}

          # Create package directory
          mkdir -p release-package

          # Copy server dist
          cp -r server/dist release-package/

          # Copy frontend dist as public
          cp -r frontend/dist release-package/public

          # Copy Prisma schema
          mkdir -p release-package/prisma
          cp server/prisma/schema.prisma release-package/prisma/

          # Copy package files (production only)
          cp server/package.json release-package/
          cp server/package-lock.json release-package/

          # Copy config template
          cp server/config.json release-package/

          # Create data directories
          mkdir -p release-package/data/{db,logs,servers,backups}

          # Copy scripts
          mkdir -p release-package/scripts
          cp -r scripts/windows release-package/scripts/
          cp -r scripts/linux release-package/scripts/

          # Create start scripts
          cat > release-package/start.sh << 'EOF'
          #!/bin/bash
          cd "$(dirname "$0")"
          export NODE_ENV=production
          export HSM_BASE_PATH="$(pwd)"
          echo "Starting Hytale Server Manager..."
          node dist/index.js
          EOF
          chmod +x release-package/start.sh

          cat > release-package/start.bat << 'EOF'
          @echo off
          cd /d "%~dp0"
          set NODE_ENV=production
          set HSM_BASE_PATH=%~dp0
          echo Starting Hytale Server Manager...
          node dist\index.js
          pause
          EOF

          # Create Windows package
          cd release-package
          zip -r ../hytale-server-manager-${VERSION}-windows.zip .
          cd ..

          # Create Linux package
          tar -czvf hytale-server-manager-${VERSION}-linux.tar.gz -C release-package .

      - name: Create GitHub Release
        uses: softprops/action-gh-release@v1
        with:
          name: v${{ steps.version.outputs.VERSION }}
          tag_name: v${{ steps.version.outputs.VERSION }}
          draft: false
          prerelease: false
          generate_release_notes: true
          files: |
            hytale-server-manager-${{ steps.version.outputs.VERSION }}-windows.zip
            hytale-server-manager-${{ steps.version.outputs.VERSION }}-linux.tar.gz
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
